---
title: 使用kubeadm引导集群
date: 2023-06-19 17:18:19
permalink: /pages/4e5ebf/
categories:
  - kubernetes
tags:
  - 
---
## 1. 机器配置
系统版本：
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22030505/1667645964065-bbb4320e-afe0-433c-8062-e6ea0816d1f4.png#averageHue=%2325221f&clientId=ua5807b6e-3918-4&from=paste&height=244&id=u96043fb7&originHeight=244&originWidth=623&originalType=binary&ratio=1&rotation=0&showTitle=false&size=23572&status=done&style=none&taskId=ua08efb5b-bfc2-459e-8917-40c16730f47&title=&width=623)
###  1.1  设置hosts、同步系统时间、关闭selinux、firewall、关闭swap、开启ipv4转发
#### 1.1.1  设置hosts （所有机器）
本次集群规模为3master 和4node ， 外加一个harbor 存储镜像 信息如下：
--> vim /etc/hosts
```shell
172.24.10.105				cluster-master-01
172.24.10.106				cluster-master-02
172.24.10.107				cluster-master-03
172.24.10.108				cluster-node-01
172.24.10.109				cluster-node-02
172.24.10.110				cluster-node-03
172.24.10.111				cluster-node-04
172.24.10.102				harbor.xiaobai1202.com

```
#### 1.1.2  关闭swap、selinux、firewall （所有机器）
```shell
# 临时关闭
root@cluster:~# swapoff -a
# 永久关闭  注释掉swap的挂载
root@cluster:~# vi /etc/fstab 
```
```shell
# 若存在配置文件
sed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config

#若不存在 则直接新建一个：
echo 'SELINUX=disabled' >> /etc/selinux/config
```
```shell
ufw disable
service ufw stop 
systemctl disable ufw
```
#### 1.1.3 同步系统时间 （所有机器）

首先，先修正系统时区 UTC+8
```shell
# 首先查看支持的时区
timedatectl list-timezones
# 下面这句有输出的话就是支持北京时间的
timedatectl list-timezones | grep 'Asia/Shanghai'
# 设置时区为北京时间
timedatectl set-timezone Asia/Shanghai
# 查看时区
timedatectl
```
输出如下为正常：
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22030505/1667648613531-6376138f-9aa5-4b56-a430-98f4479f3901.png#averageHue=%23272521&clientId=u47b38a58-3c32-4&from=paste&height=158&id=u16311958&originHeight=158&originWidth=465&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12676&status=done&style=none&taskId=u6f493c48-aa2d-40b0-b178-98b562e924d&title=&width=465)

然后使用时间服务器进行同步
```shell
# 关闭默认同步
timedatectl set-ntp false 
# 安装ntpdate
apt install ntpdate 
# 同步时间  
/usr/sbin/ntpdate ntp.aliyun.co
# 配置每天定时同步
crontab -e
# 添加如下行
## 05 00 * * * /usr/sbin/ntpdate ntp.aliyun.com
```

#### 1.1.4 开启转发 （所有机器）
```shell
# 第一步
modprobe overlay
modprobe br_netfilter
lsmod | grep br_netfilter
# 第二步  写入配置
cat > /etc/sysctl.d/k8s.conf <<EOF
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_forward = 1
EOF
# 第三步  刷新配置
sysctl -p /etc/sysctl.d/k8s.conf
```

### 1.2  安装容器运行时 containerd （所有机器）
#### 1.2.1 安装参考
[https://github.com/containerd/containerd/blob/main/docs/getting-started.md](https://github.com/containerd/containerd/blob/main/docs/getting-started.md)
安装containerd/ runc/ cni plugins
```shell
wget  https://github.com/containerd/containerd/releases/download/v1.6.9/containerd-1.6.9-linux-amd64.tar.gz

tar Cxzvf /usr/local containerd-1.6.2-linux-amd64.tar.gz

cat > /usr/lib/systemd/system/containerd.service <<EOF
# Copyright The containerd Authors.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
#uncomment to enable the experimental sbservice (sandboxed) version of containerd/cri integration
#Environment="ENABLE_CRI_SANDBOXES=sandboxed"
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/local/bin/containerd

Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
# Having non-zero Limit*s causes performance problems due to accounting overhead
# in the kernel. We recommend using cgroups to do container-local accounting.
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=infinity
# Comment TasksMax if your systemd version does not supports it.
# Only systemd 226 and above support this version.
TasksMax=infinity
OOMScoreAdjust=-999
EOF

systemctl daemon-reload
systemctl enable --now containerd

service containerd status


wget https://github.com/opencontainers/runc/releases/download/v1.1.4/runc.amd64

install -m 755 runc.amd64 /usr/local/sbin/runc


mkdir -p /opt/cni/bin

wget https://github.com/containernetworking/plugins/releases/download/v1.1.1/cni-plugins-linux-amd64-v1.1.1.tgz

tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz 



```
#### 1.2.2 配置containerd 使用 systems cgroup （所有机器）
首先 生成默认配置：
```shell
sudo mkdir -p /etc/containerd/
containerd config default | sudo tee /etc/containerd/config.toml
```
然后替换其中的cgroup驱动为systemd
```shell
sed -i 's/SystemdCgroup \= false/SystemdCgroup \= true/g' /etc/containerd/config.toml
### 重点  这个一定要改
sandbox_image = "registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6"

systemctl restart containerd.service 
systemctl enable containerd.service
```

### 1.3 引导集群
#### 1.3.1 一些必要的工具（kubeadm、kubelet、kubectl、crictl） （所有机器）
```shell
wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.25.0/crictl-v1.25.0-linux-amd64.tar.gz

tar Cxzvf /usr/local/bin crictl-v1.25.0-linux-amd64.tar.gz

## 配置文件（/etc/crictl.yaml）

runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
pull-image-on-create: false
disable-pull-on-run: false

```
```shell
apt install install -y apt-transport-https ca-certificates curl

curl -fsSLo /usr/share/keyrings/kubernetes-archive-keyring.gpg  https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg

echo "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] http://mirrors.aliyun.com/kubernetes/apt kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list

apt update

apt install kubeadm=1.25.3-00
apt install kubectl=1.25.3-00
apt install kubelet=1.25.3-00

# 冻结版本
apt-mark hold kubelet kubeadm kubectl
```
#### 1.3.2 为master 安装keepalived并配置 实现高可用 （只有master节点）
```shell
apt install keepalived libul* 
```
在每个master节点的  /etc/keepalived 下面新建 k8s.conf (内容相同但是 vrrp_instance.priority不同)
```nginx
global_defs {
   router_id LVS_DEVEL
}
vrrp_instance VI_1 {
    state BACKUP
    nopreempt
    interface ens32
    virtual_router_id 80
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass just0kk
    }
    virtual_ipaddress {
        172.24.10.201/24
    }
}
virtual_server 172.24.10.201 6443 {
    delay_loop 6
    lb_algo loadbalance
    lb_kind DR
    net_mask 255.255.255.0
    persistence_timeout 0
    protocol TCP
    real_server 172.24.10.105 6443 {
        weight 1
        SSL_GET {
            url {
              path /healthz
              status_code 200
            }
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
        }
    }
    real_server 172.24.10.106 6443 {
        weight 1
        SSL_GET {
            url {
              path /healthz
              status_code 200
            }
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
        }
    }
    real_server 172.24.10.107 6443 {
        weight 1
        SSL_GET {
            url {
              path /healthz
              status_code 200
            }
            connect_timeout 3
            nb_get_retry 3
            delay_before_retry 3
        }
    }
}
```
配置文件编辑好以后就可以启动了 
```shell
systemctl enable keepalived  && systemctl start keepalived  && systemctl status keepalived
```
#### 1.3.3 准备正式引导集群（master节点）
 在一个master 节点执行
```shell
kubeadm init \
--apiserver-advertise-address 0.0.0.0 \
--apiserver-bind-port 6443 \
--control-plane-endpoint 172.24.10.201 \
--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers \
--kubernetes-version v1.25.3 \
--pod-network-cidr 172.16.0.0/16 \
--service-cidr 10.221.0.0/16 \
--service-dns-domain k8s.xiaobai1202.com \
--upload-certs
```
执行完毕后 结果如下：
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22030505/1667663066722-9545d910-45c9-43ee-a080-bbe8e7368400.png#averageHue=%23282220&clientId=u47b38a58-3c32-4&from=paste&height=676&id=ub19adb19&originHeight=676&originWidth=967&originalType=binary&ratio=1&rotation=0&showTitle=false&size=90085&status=done&style=none&taskId=ua112f47f-632a-4803-8f86-f81ba82f469&title=&width=967)
红框中的命令，若要加入更多的master 使用第一个命令  若要加入node 使用第二个命令

最后检查集群状态：
```shell
# 任意一个master 执行
kubectl get nodes
```
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22030505/1667663468047-fccc5159-c2f6-475f-98f9-e26406f6b34f.png#averageHue=%232b2723&clientId=u47b38a58-3c32-4&from=paste&height=176&id=uf5607b7f&originHeight=176&originWidth=502&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11448&status=done&style=none&taskId=u742c476c-dd01-4350-8ccb-b2011d50a54&title=&width=502)
not ready 是因为集群的网络插件没有安装 下一步 安装网络插件

### 1.4 安装网络插件
使用calico 
[https://raw.githubusercontent.com/projectcalico/calico/v3.24.4/manifests/tigera-operator.yaml](https://raw.githubusercontent.com/projectcalico/calico/v3.24.4/manifests/tigera-operator.yaml)

然后查看节点状态：
![image.png](https://cdn.nlark.com/yuque/0/2022/png/22030505/1667664782093-ab380a30-1a92-45fb-8b39-e638118f97f5.png#averageHue=%232c2724&clientId=u47b38a58-3c32-4&from=paste&height=155&id=u819dc43c&originHeight=155&originWidth=456&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8583&status=done&style=none&taskId=u853fbeb4-1b6d-4227-8f1e-950e514d4da&title=&width=456)
done！
